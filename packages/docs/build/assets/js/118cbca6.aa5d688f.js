"use strict";(self.webpackChunknext_auth_docs=self.webpackChunknext_auth_docs||[]).push([[7093],{3905:function(e,t,n){n.d(t,{Zo:function(){return c},kt:function(){return p}});var r=n(7294);function a(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function i(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function o(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?i(Object(n),!0).forEach((function(t){a(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):i(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function s(e,t){if(null==e)return{};var n,r,a=function(e,t){if(null==e)return{};var n,r,a={},i=Object.keys(e);for(r=0;r<i.length;r++)n=i[r],t.indexOf(n)>=0||(a[n]=e[n]);return a}(e,t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);for(r=0;r<i.length;r++)n=i[r],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(a[n]=e[n])}return a}var u=r.createContext({}),l=function(e){var t=r.useContext(u),n=t;return e&&(n="function"==typeof e?e(t):o(o({},t),e)),n},c=function(e){var t=l(e.components);return r.createElement(u.Provider,{value:t},e.children)},h={inlineCode:"code",wrapper:function(e){var t=e.children;return r.createElement(r.Fragment,{},t)}},d=r.forwardRef((function(e,t){var n=e.components,a=e.mdxType,i=e.originalType,u=e.parentName,c=s(e,["components","mdxType","originalType","parentName"]),d=l(n),p=a,m=d["".concat(u,".").concat(p)]||d[p]||h[p]||i;return n?r.createElement(m,o(o({ref:t},c),{},{components:n})):r.createElement(m,o({ref:t},c))}));function p(e,t){var n=arguments,a=t&&t.mdxType;if("string"==typeof e||a){var i=n.length,o=new Array(i);o[0]=d;var s={};for(var u in t)hasOwnProperty.call(t,u)&&(s[u]=t[u]);s.originalType=e,s.mdxType="string"==typeof e?e:a,o[1]=s;for(var l=2;l<i;l++)o[l]=n[l];return r.createElement.apply(null,o)}return r.createElement.apply(null,n)}d.displayName="MDXCreateElement"},8215:function(e,t,n){var r=n(7294);t.Z=function(e){var t=e.children,n=e.hidden,a=e.className;return r.createElement("div",{role:"tabpanel",hidden:n,className:a},t)}},6396:function(e,t,n){n.d(t,{Z:function(){return d}});var r=n(7462),a=n(7294),i=n(2389),o=n(9443);var s=function(){var e=(0,a.useContext)(o.Z);if(null==e)throw new Error('"useUserPreferencesContext" is used outside of "Layout" component.');return e},u=n(9521),l=n(6010),c="tabItem_vU9c";function h(e){var t,n,r,i=e.lazy,o=e.block,h=e.defaultValue,d=e.values,p=e.groupId,m=e.className,g=a.Children.map(e.children,(function(e){if((0,a.isValidElement)(e)&&void 0!==e.props.value)return e;throw new Error("Docusaurus error: Bad <Tabs> child <"+("string"==typeof e.type?e.type:e.type.name)+'>: all children of the <Tabs> component should be <TabItem>, and every <TabItem> should have a unique "value" prop.')})),f=null!=d?d:g.map((function(e){var t=e.props;return{value:t.value,label:t.label}})),v=(0,u.lx)(f,(function(e,t){return e.value===t.value}));if(v.length>0)throw new Error('Docusaurus error: Duplicate values "'+v.map((function(e){return e.value})).join(", ")+'" found in <Tabs>. Every value needs to be unique.');var y=null===h?h:null!=(t=null!=h?h:null==(n=g.find((function(e){return e.props.default})))?void 0:n.props.value)?t:null==(r=g[0])?void 0:r.props.value;if(null!==y&&!f.some((function(e){return e.value===y})))throw new Error('Docusaurus error: The <Tabs> has a defaultValue "'+y+'" but none of its children has the corresponding value. Available values are: '+f.map((function(e){return e.value})).join(", ")+". If you intend to show no default tab, use defaultValue={null} instead.");var k=s(),b=k.tabGroupChoices,w=k.setTabGroupChoices,x=(0,a.useState)(y),N=x[0],S=x[1],T=[],A=(0,u.o5)().blockElementScrollPositionUntilNextRender;if(null!=p){var E=b[p];null!=E&&E!==N&&f.some((function(e){return e.value===E}))&&S(E)}var D=function(e){var t=e.currentTarget,n=T.indexOf(t),r=f[n].value;r!==N&&(A(t),S(r),null!=p&&w(p,r))},j=function(e){var t,n=null;switch(e.key){case"ArrowRight":var r=T.indexOf(e.currentTarget)+1;n=T[r]||T[0];break;case"ArrowLeft":var a=T.indexOf(e.currentTarget)-1;n=T[a]||T[T.length-1]}null==(t=n)||t.focus()};return a.createElement("div",{className:"tabs-container"},a.createElement("ul",{role:"tablist","aria-orientation":"horizontal",className:(0,l.Z)("tabs",{"tabs--block":o},m)},f.map((function(e){var t=e.value,n=e.label;return a.createElement("li",{role:"tab",tabIndex:N===t?0:-1,"aria-selected":N===t,className:(0,l.Z)("tabs__item",c,{"tabs__item--active":N===t}),key:t,ref:function(e){return T.push(e)},onKeyDown:j,onFocus:D,onClick:D},null!=n?n:t)}))),i?(0,a.cloneElement)(g.filter((function(e){return e.props.value===N}))[0],{className:"margin-vert--md"}):a.createElement("div",{className:"margin-vert--md"},g.map((function(e,t){return(0,a.cloneElement)(e,{key:t,hidden:e.props.value!==N})}))))}function d(e){var t=(0,i.Z)();return a.createElement(h,(0,r.Z)({key:String(t)},e))}},9443:function(e,t,n){var r=(0,n(7294).createContext)(void 0);t.Z=r},7909:function(e,t,n){n.r(t),n.d(t,{frontMatter:function(){return l},contentTitle:function(){return c},metadata:function(){return h},toc:function(){return d},default:function(){return m}});var r=n(7462),a=n(3366),i=(n(7294),n(3905)),o=n(6396),s=n(8215),u=["components"],l={id:"dgraph",title:"Dgraph"},c="Dgraph",h={unversionedId:"adapters/dgraph",id:"adapters/dgraph",isDocsHomePage:!1,title:"Dgraph",description:"This is the Dgraph Adapter for next-auth.",source:"@site/docs/adapters/dgraph.md",sourceDirName:"adapters",slug:"/adapters/dgraph",permalink:"/adapters/dgraph",editUrl:"https://github.com/nextauthjs/docs/edit/main/docs/adapters/dgraph.md",tags:[],version:"current",lastUpdatedBy:"Bal\xe1zs Orb\xe1n",lastUpdatedAt:1643982356,formattedLastUpdatedAt:"2/4/2022",frontMatter:{id:"dgraph",title:"Dgraph"},sidebar:"docs",previous:{title:"MikroORM",permalink:"/adapters/mikro-orm"},next:{title:"Upstash Redis",permalink:"/adapters/upstash-redis"}},d=[{value:"Getting Started",id:"getting-started",children:[],level:2},{value:"Quick start with the unsecure schema",id:"quick-start-with-the-unsecure-schema",children:[{value:"Unsecure schema",id:"unsecure-schema",children:[],level:4}],level:2},{value:"Securing your database",id:"securing-your-database",children:[{value:"Secure schema",id:"secure-schema",children:[],level:4},{value:"Dgraph.Authorization",id:"dgraphauthorization",children:[],level:4},{value:"VerificationKey and jwtSecret",id:"verificationkey-and-jwtsecret",children:[],level:4},{value:"Header and authHeader",id:"header-and-authheader",children:[],level:4},{value:"The nextAuth secret",id:"the-nextauth-secret",children:[],level:4}],level:2},{value:"Working with JWT session and @auth directive",id:"working-with-jwt-session-and-auth-directive",children:[],level:2}],p={toc:d};function m(e){var t=e.components,n=(0,a.Z)(e,u);return(0,i.kt)("wrapper",(0,r.Z)({},p,n,{components:t,mdxType:"MDXLayout"}),(0,i.kt)("h1",{id:"dgraph"},"Dgraph"),(0,i.kt)("p",null,"This is the Dgraph Adapter for ",(0,i.kt)("a",{parentName:"p",href:"https://next-auth.js.org"},(0,i.kt)("inlineCode",{parentName:"a"},"next-auth")),"."),(0,i.kt)("h2",{id:"getting-started"},"Getting Started"),(0,i.kt)("ol",null,(0,i.kt)("li",{parentName:"ol"},"Install the necessary packages")),(0,i.kt)(o.Z,{groupId:"npm2yarn",mdxType:"Tabs"},(0,i.kt)(s.Z,{value:"npm",mdxType:"TabItem"},(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-bash"},"npm install next-auth @next-auth/dgraph-adapter\n"))),(0,i.kt)(s.Z,{value:"yarn",label:"Yarn",mdxType:"TabItem"},(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-bash"},"yarn add next-auth @next-auth/dgraph-adapter\n")))),(0,i.kt)("ol",{start:2},(0,i.kt)("li",{parentName:"ol"},"Add this adapter to your ",(0,i.kt)("inlineCode",{parentName:"li"},"pages/api/[...nextauth].js")," next-auth configuration object.")),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-javascript",metastring:'title="pages/api/auth/[...nextauth].js"',title:'"pages/api/auth/[...nextauth].js"'},'import NextAuth from "next-auth"\nimport { DgraphAdapter } from "@next-auth/dgraph-adapter"\n\n// For more information on each option (and a full list of options) go to\n// https://next-auth.js.org/configuration/options\nexport default NextAuth({\n  // https://next-auth.js.org/configuration/providers\n  providers: [],\n  adapter: DgraphAdapter({\n    endpoint: process.env.DGRAPH_GRAPHQL_ENDPOINT,\n    authToken: process.env.DGRAPH_GRAPHQL_KEY,\n\n    // you can omit the following properties if you are running an unsecure schema\n    authHeader: process.env.AUTH_HEADER, // default: "Authorization",\n    jwtSecret: process.env.SECRET,\n  }),\n})\n')),(0,i.kt)("h2",{id:"quick-start-with-the-unsecure-schema"},"Quick start with the unsecure schema"),(0,i.kt)("p",null,"The quickest way to use Dgraph is by applying the unsecure schema to your ",(0,i.kt)("a",{parentName:"p",href:"https://dgraph.io/docs/graphql/admin/#modifying-a-schema"},"local")," Dgraph instance or if using Dgraph ",(0,i.kt)("a",{parentName:"p",href:"https://dgraph.io/docs/cloud/cloud-quick-start/#the-schema"},"cloud")," you can paste the schema in the codebox to update."),(0,i.kt)("div",{className:"admonition admonition-warning alert alert--danger"},(0,i.kt)("div",{parentName:"div",className:"admonition-heading"},(0,i.kt)("h5",{parentName:"div"},(0,i.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,i.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"12",height:"16",viewBox:"0 0 12 16"},(0,i.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M5.05.31c.81 2.17.41 3.38-.52 4.31C3.55 5.67 1.98 6.45.9 7.98c-1.45 2.05-1.7 6.53 3.53 7.7-2.2-1.16-2.67-4.52-.3-6.61-.61 2.03.53 3.33 1.94 2.86 1.39-.47 2.3.53 2.27 1.67-.02.78-.31 1.44-1.13 1.81 3.42-.59 4.78-3.42 4.78-5.56 0-2.84-2.53-3.22-1.25-5.61-1.52.13-2.03 1.13-1.89 2.75.09 1.08-1.02 1.8-1.86 1.33-.67-.41-.66-1.19-.06-1.78C8.18 5.31 8.68 2.45 5.05.32L5.03.3l.02.01z"}))),"warning")),(0,i.kt)("div",{parentName:"div",className:"admonition-content"},(0,i.kt)("p",{parentName:"div"},"This approach is not secure or for production use, and does not require a ",(0,i.kt)("inlineCode",{parentName:"p"},"jwtSecret"),"."))),(0,i.kt)("h4",{id:"unsecure-schema"},"Unsecure schema"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-graphql"},'type Account {\n  id: ID\n  type: String\n  provider: String @search(by: [hash])\n  providerAccountId: String @search(by: [hash])\n  refreshToken: String\n  expires_at: Int64\n  accessToken: String\n  token_type: String\n  refresh_token: String\n  access_token: String\n  scope: String\n  id_token: String\n  session_state: String\n  user: User @hasInverse(field: "accounts")\n}\ntype Session {\n  id: ID\n  expires: DateTime\n  sessionToken: String @search(by: [hash])\n  user: User @hasInverse(field: "sessions")\n}\ntype User {\n  id: ID\n  name: String\n  email: String @search(by: [hash])\n  emailVerified: DateTime\n  image: String\n  accounts: [Account] @hasInverse(field: "user")\n  sessions: [Session] @hasInverse(field: "user")\n}\n\ntype VerificationToken {\n  id: ID\n  identifier: String @search(by: [hash])\n  token: String @search(by: [hash])\n  expires: DateTime\n}\n')),(0,i.kt)("h2",{id:"securing-your-database"},"Securing your database"),(0,i.kt)("p",null,"For production deployments you will want to restrict the access to the types used\nby next-auth. The main form of access control used in Dgraph is via ",(0,i.kt)("inlineCode",{parentName:"p"},"@auth")," directive alongide types in the schema."),(0,i.kt)("h4",{id:"secure-schema"},"Secure schema"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-graphql"},'type Account\n  @auth(\n    delete: { rule: "{$nextAuth { eq: true } }" }\n    add: { rule: "{$nextAuth { eq: true } }" }\n    query: { rule: "{$nextAuth { eq: true } }" }\n    update: { rule: "{$nextAuth { eq: true } }" }\n  ) {\n  id: ID\n  type: String\n  provider: String @search(by: [hash])\n  providerAccountId: String @search(by: [hash])\n  refreshToken: String\n  expires_at: Int64\n  accessToken: String\n  token_type: String\n  refresh_token: String\n  access_token: String\n  scope: String\n  id_token: String\n  session_state: String\n  user: User @hasInverse(field: "accounts")\n}\ntype Session\n  @auth(\n    delete: { rule: "{$nextAuth { eq: true } }" }\n    add: { rule: "{$nextAuth { eq: true } }" }\n    query: { rule: "{$nextAuth { eq: true } }" }\n    update: { rule: "{$nextAuth { eq: true } }" }\n  ) {\n  id: ID\n  expires: DateTime\n  sessionToken: String @search(by: [hash])\n  user: User @hasInverse(field: "sessions")\n}\ntype User\n  @auth(\n    query: {\n      or: [\n        {\n          rule: """\n          query ($userId: String!) {queryUser(filter: { id: { eq: $userId } } ) {id}}\n          """\n        }\n        { rule: "{$nextAuth { eq: true } }" }\n      ]\n    }\n    delete: { rule: "{$nextAuth { eq: true } }" }\n    add: { rule: "{$nextAuth { eq: true } }" }\n    update: {\n      or: [\n        {\n          rule: """\n          query ($userId: String!) {queryUser(filter: { id: { eq: $userId } } ) {id}}\n          """\n        }\n        { rule: "{$nextAuth { eq: true } }" }\n      ]\n    }\n  ) {\n  id: ID\n  name: String\n  email: String @search(by: [hash])\n  emailVerified: DateTime\n  image: String\n  accounts: [Account] @hasInverse(field: "user")\n  sessions: [Session] @hasInverse(field: "user")\n}\n\ntype VerificationToken\n  @auth(\n    delete: { rule: "{$nextAuth { eq: true } }" }\n    add: { rule: "{$nextAuth { eq: true } }" }\n    query: { rule: "{$nextAuth { eq: true } }" }\n    update: { rule: "{$nextAuth { eq: true } }" }\n  ) {\n  id: ID\n  identifier: String @search(by: [hash])\n  token: String @search(by: [hash])\n  expires: DateTime\n}\n\n# Dgraph.Authorization {"VerificationKey":"<YOUR JWT SECRET HERE>","Header":"<YOUR AUTH HEADER HERE>","Namespace":"<YOUR CUSTOM NAMESPACE HERE>","Algo":"HS256"}\n')),(0,i.kt)("h4",{id:"dgraphauthorization"},"Dgraph.Authorization"),(0,i.kt)("p",null,"In order to secure your graphql backend define the ",(0,i.kt)("inlineCode",{parentName:"p"},"Dgraph.Authorization")," object at the\nbottom of your schema and provide ",(0,i.kt)("inlineCode",{parentName:"p"},"authHeader")," and ",(0,i.kt)("inlineCode",{parentName:"p"},"jwtSecret")," values to the DgraphClient."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-js"},'# Dgraph.Authorization {"VerificationKey":"<YOUR JWT SECRET HERE>","Header":"<YOUR AUTH HEADER HERE>","Namespace":"YOUR CUSTOM NAMESPACE HERE","Algo":"HS256"}\n')),(0,i.kt)("h4",{id:"verificationkey-and-jwtsecret"},"VerificationKey and jwtSecret"),(0,i.kt)("p",null,"This is the key used to sign the JWT. Ex. ",(0,i.kt)("inlineCode",{parentName:"p"},"process.env.SECRET")," or ",(0,i.kt)("inlineCode",{parentName:"p"},"process.env.APP_SECRET"),"."),(0,i.kt)("h4",{id:"header-and-authheader"},"Header and authHeader"),(0,i.kt)("p",null,"The ",(0,i.kt)("inlineCode",{parentName:"p"},"Header")," tells Dgraph where to lookup a JWT within the headers of the incoming requests made to the dgraph server.\nYou have to configure it at the bottom of your schema file. This header is the same as the ",(0,i.kt)("inlineCode",{parentName:"p"},"authHeader")," property you\nprovide when you instantiate the ",(0,i.kt)("inlineCode",{parentName:"p"},"DgraphClient"),"."),(0,i.kt)("h4",{id:"the-nextauth-secret"},"The nextAuth secret"),(0,i.kt)("p",null,"The ",(0,i.kt)("inlineCode",{parentName:"p"},"$nextAuth")," secret is securely generated using the ",(0,i.kt)("inlineCode",{parentName:"p"},"jwtSecret")," and injected by the DgraphAdapter in order to allow interacting with the JWT DgraphClient for anonymous user requests made within the system ",(0,i.kt)("inlineCode",{parentName:"p"},"ie. login, register"),". This allows\nsecure interactions to be made with all the auth types required by next-auth. You have to specify it for each auth rule of\neach type defined in your secure schema."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-js"},'type VerificationRequest\n  @auth(\n    delete: { rule: "{$nextAuth: { eq: true } }" },\n    add: { rule: "{$nextAuth: { eq: true } }" },\n    query: { rule: "{$nextAuth: { eq: true } }" },\n    update: { rule: "{$nextAuth: { eq: true } }" }\n  ) {\n ...\n}\n')),(0,i.kt)("h2",{id:"working-with-jwt-session-and-auth-directive"},"Working with JWT session and ",(0,i.kt)("a",{parentName:"h2",href:"https://github.com/auth"},(0,i.kt)("strong",{parentName:"a"},"@auth"))," directive"),(0,i.kt)("p",null,"Dgraph only works with HS256 or RS256 algorithms. If you want to use session jwt to securely interact with your dgraph\ndatabase you must customize next-auth ",(0,i.kt)("inlineCode",{parentName:"p"},"encode")," and ",(0,i.kt)("inlineCode",{parentName:"p"},"decode")," functions, as the default algorithm is HS512. You can\nfurther customize the jwt with roles if you want to implement ",(0,i.kt)("a",{parentName:"p",href:"https://dgraph.io/docs/graphql/authorization/directive/#role-based-access-control"},(0,i.kt)("inlineCode",{parentName:"a"},"RBAC logic")),"."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-js"},'import * as jwt from "jsonwebtoken";\nexport default NextAuth({\n  session: {\n    jwt: true\n  },\n  jwt: {\n    secret: process.env.SECRET,\n    encode: async ({ secret, token }) => {\n      return jwt.sign({...token, userId: token.id}, secret, {\n        algorithm: "HS256",\n        expiresIn: 30 * 24 * 60 * 60; // 30 days\n      });;\n    },\n    decode: async ({ secret, token }) => {\n      return jwt.verify(token, secret, { algorithms: ["HS256"] });\n    }\n  },\n})\n')),(0,i.kt)("p",null,"Once your ",(0,i.kt)("inlineCode",{parentName:"p"},"Dgraph.Authorization")," is defined in your schema and the JWT settings are set, this will allow you to define\n",(0,i.kt)("a",{parentName:"p",href:"https://dgraph.io/docs/graphql/authorization/authorization-overview/"},(0,i.kt)("inlineCode",{parentName:"a"},"@auth rules"))," for every part of your schema."))}m.isMDXComponent=!0}}]);