"use strict";(self.webpackChunknext_auth_docs=self.webpackChunknext_auth_docs||[]).push([[736],{3905:function(e,n,t){t.d(n,{Zo:function(){return c},kt:function(){return m}});var r=t(7294);function o(e,n,t){return n in e?Object.defineProperty(e,n,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[n]=t,e}function a(e,n){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);n&&(r=r.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),t.push.apply(t,r)}return t}function s(e){for(var n=1;n<arguments.length;n++){var t=null!=arguments[n]?arguments[n]:{};n%2?a(Object(t),!0).forEach((function(n){o(e,n,t[n])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):a(Object(t)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(t,n))}))}return e}function i(e,n){if(null==e)return{};var t,r,o=function(e,n){if(null==e)return{};var t,r,o={},a=Object.keys(e);for(r=0;r<a.length;r++)t=a[r],n.indexOf(t)>=0||(o[t]=e[t]);return o}(e,n);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);for(r=0;r<a.length;r++)t=a[r],n.indexOf(t)>=0||Object.prototype.propertyIsEnumerable.call(e,t)&&(o[t]=e[t])}return o}var l=r.createContext({}),u=function(e){var n=r.useContext(l),t=n;return e&&(t="function"==typeof e?e(n):s(s({},n),e)),t},c=function(e){var n=u(e.components);return r.createElement(l.Provider,{value:n},e.children)},p={inlineCode:"code",wrapper:function(e){var n=e.children;return r.createElement(r.Fragment,{},n)}},d=r.forwardRef((function(e,n){var t=e.components,o=e.mdxType,a=e.originalType,l=e.parentName,c=i(e,["components","mdxType","originalType","parentName"]),d=u(t),m=o,g=d["".concat(l,".").concat(m)]||d[m]||p[m]||a;return t?r.createElement(g,s(s({ref:n},c),{},{components:t})):r.createElement(g,s({ref:n},c))}));function m(e,n){var t=arguments,o=n&&n.mdxType;if("string"==typeof e||o){var a=t.length,s=new Array(a);s[0]=d;var i={};for(var l in n)hasOwnProperty.call(n,l)&&(i[l]=n[l]);i.originalType=e,i.mdxType="string"==typeof e?e:o,s[1]=i;for(var u=2;u<a;u++)s[u]=t[u];return r.createElement.apply(null,s)}return r.createElement.apply(null,t)}d.displayName="MDXCreateElement"},8215:function(e,n,t){var r=t(7294);n.Z=function(e){var n=e.children,t=e.hidden,o=e.className;return r.createElement("div",{role:"tabpanel",hidden:t,className:o},n)}},6396:function(e,n,t){t.d(n,{Z:function(){return d}});var r=t(7462),o=t(7294),a=t(2389),s=t(9443);var i=function(){var e=(0,o.useContext)(s.Z);if(null==e)throw new Error('"useUserPreferencesContext" is used outside of "Layout" component.');return e},l=t(9521),u=t(6010),c="tabItem_vU9c";function p(e){var n,t,r,a=e.lazy,s=e.block,p=e.defaultValue,d=e.values,m=e.groupId,g=e.className,y=o.Children.map(e.children,(function(e){if((0,o.isValidElement)(e)&&void 0!==e.props.value)return e;throw new Error("Docusaurus error: Bad <Tabs> child <"+("string"==typeof e.type?e.type:e.type.name)+'>: all children of the <Tabs> component should be <TabItem>, and every <TabItem> should have a unique "value" prop.')})),f=null!=d?d:y.map((function(e){var n=e.props;return{value:n.value,label:n.label}})),h=(0,l.lx)(f,(function(e,n){return e.value===n.value}));if(h.length>0)throw new Error('Docusaurus error: Duplicate values "'+h.map((function(e){return e.value})).join(", ")+'" found in <Tabs>. Every value needs to be unique.');var v=null===p?p:null!=(n=null!=p?p:null==(t=y.find((function(e){return e.props.default})))?void 0:t.props.value)?n:null==(r=y[0])?void 0:r.props.value;if(null!==v&&!f.some((function(e){return e.value===v})))throw new Error('Docusaurus error: The <Tabs> has a defaultValue "'+v+'" but none of its children has the corresponding value. Available values are: '+f.map((function(e){return e.value})).join(", ")+". If you intend to show no default tab, use defaultValue={null} instead.");var k=i(),b=k.tabGroupChoices,w=k.setTabGroupChoices,N=(0,o.useState)(v),O=N[0],C=N[1],E=[],j=(0,l.o5)().blockElementScrollPositionUntilNextRender;if(null!=m){var T=b[m];null!=T&&T!==O&&f.some((function(e){return e.value===T}))&&C(T)}var x=function(e){var n=e.currentTarget,t=E.indexOf(n),r=f[t].value;r!==O&&(j(n),C(r),null!=m&&w(m,r))},S=function(e){var n,t=null;switch(e.key){case"ArrowRight":var r=E.indexOf(e.currentTarget)+1;t=E[r]||E[0];break;case"ArrowLeft":var o=E.indexOf(e.currentTarget)-1;t=E[o]||E[E.length-1]}null==(n=t)||n.focus()};return o.createElement("div",{className:"tabs-container"},o.createElement("ul",{role:"tablist","aria-orientation":"horizontal",className:(0,u.Z)("tabs",{"tabs--block":s},g)},f.map((function(e){var n=e.value,t=e.label;return o.createElement("li",{role:"tab",tabIndex:O===n?0:-1,"aria-selected":O===n,className:(0,u.Z)("tabs__item",c,{"tabs__item--active":O===n}),key:n,ref:function(e){return E.push(e)},onKeyDown:S,onFocus:x,onClick:x},null!=t?t:n)}))),a?(0,o.cloneElement)(y.filter((function(e){return e.props.value===O}))[0],{className:"margin-vert--md"}):o.createElement("div",{className:"margin-vert--md"},y.map((function(e,n){return(0,o.cloneElement)(e,{key:n,hidden:e.props.value!==O})}))))}function d(e){var n=(0,a.Z)();return o.createElement(p,(0,r.Z)({key:String(n)},e))}},9443:function(e,n,t){var r=(0,t(7294).createContext)(void 0);n.Z=r},5680:function(e,n,t){t.r(n),t.d(n,{frontMatter:function(){return u},contentTitle:function(){return c},metadata:function(){return p},toc:function(){return d},default:function(){return g}});var r=t(7462),o=t(3366),a=(t(7294),t(3905)),s=t(6396),i=t(8215),l=["components"],u={id:"testing-with-cypress",title:"Testing with Cypress"},c=void 0,p={unversionedId:"tutorials/testing-with-cypress",id:"tutorials/testing-with-cypress",isDocsHomePage:!1,title:"Testing with Cypress",description:"To test an implementation of NextAuth.js, we encourage you to use Cypress.",source:"@site/docs/tutorials/testing-with-cypress.md",sourceDirName:"tutorials",slug:"/tutorials/testing-with-cypress",permalink:"/tutorials/testing-with-cypress",editUrl:"https://github.com/nextauthjs/docs/edit/main/docs/tutorials/testing-with-cypress.md",tags:[],version:"current",lastUpdatedBy:"Bal\xe1zs Orb\xe1n",lastUpdatedAt:1643982356,formattedLastUpdatedAt:"2/4/2022",frontMatter:{id:"testing-with-cypress",title:"Testing with Cypress"}},d=[{value:"Setting up Cypress",id:"setting-up-cypress",children:[],level:2},{value:"Writing a test",id:"writing-a-test",children:[],level:2}],m={toc:d};function g(e){var n=e.components,t=(0,o.Z)(e,l);return(0,a.kt)("wrapper",(0,r.Z)({},m,t,{components:n,mdxType:"MDXLayout"}),(0,a.kt)("p",null,"To test an implementation of NextAuth.js, we encourage you to use ",(0,a.kt)("a",{parentName:"p",href:"https://cypress.io"},"Cypress"),"."),(0,a.kt)("h2",{id:"setting-up-cypress"},"Setting up Cypress"),(0,a.kt)("p",null,"To get started, install the dependencies:"),(0,a.kt)(s.Z,{groupId:"npm2yarn",mdxType:"Tabs"},(0,a.kt)(i.Z,{value:"npm",mdxType:"TabItem"},(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"npm install --save-dev cypress cypress-social-logins @testing-library/cypress\n"))),(0,a.kt)(i.Z,{value:"yarn",label:"Yarn",mdxType:"TabItem"},(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"yarn add --dev cypress cypress-social-logins @testing-library/cypress\n")))),(0,a.kt)("div",{className:"admonition admonition-note alert alert--secondary"},(0,a.kt)("div",{parentName:"div",className:"admonition-heading"},(0,a.kt)("h5",{parentName:"div"},(0,a.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,a.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"14",height:"16",viewBox:"0 0 14 16"},(0,a.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"}))),"note")),(0,a.kt)("div",{parentName:"div",className:"admonition-content"},(0,a.kt)("p",{parentName:"div"},"If you are using username/password based login, you will not need the ",(0,a.kt)("inlineCode",{parentName:"p"},"cypress-social-login")," dependency."))),(0,a.kt)("p",null,"Cypress will install and initialize the folder structure with example integration tests, a folder for plugins, etc."),(0,a.kt)("p",null,"Next you will have to create some configuration files for Cypress."),(0,a.kt)("p",null,"First, the primary cypress config:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-js",metastring:'title="cypress.json"',title:'"cypress.json"'},'{\n  "baseUrl": "http://localhost:3000",\n  "chromeWebSecurity": false\n}\n')),(0,a.kt)("p",null,"This initial Cypress config will tell Cypress where to find your site on initial launch as well as allow it to open up URLs at domains that aren't your page, for example to be able to login to a social provider."),(0,a.kt)("p",null,"Second, a cypress file for environment variables. These can be defined in ",(0,a.kt)("inlineCode",{parentName:"p"},"cypress.json")," under the key ",(0,a.kt)("inlineCode",{parentName:"p"},"env")," as well, however since we're storing username / passwords in here we should keep those in a separate file and only commit ",(0,a.kt)("inlineCode",{parentName:"p"},"cypress.json")," to version control, not ",(0,a.kt)("inlineCode",{parentName:"p"},"cypress.env.json"),"."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-js",metastring:'title="cypress.env.json"',title:'"cypress.env.json"'},'{\n  "GOOGLE_USER": "username@company.com",\n  "GOOGLE_PW": "password",\n  "COOKIE_NAME": "next-auth.session-token",\n  "SITE_NAME": "http://localhost:3000"\n}\n')),(0,a.kt)("p",null,"You must change the login credentials you want to use, but you can also redefine the name of the ",(0,a.kt)("inlineCode",{parentName:"p"},"GOOGLE_*")," variables if you're using a different provider. ",(0,a.kt)("inlineCode",{parentName:"p"},"COOKIE_NAME"),", however, must be set to that value for NextAuth.js."),(0,a.kt)("p",null,"Third, if you're using the ",(0,a.kt)("inlineCode",{parentName:"p"},"cypress-social-login")," plugin, you must add this to your ",(0,a.kt)("inlineCode",{parentName:"p"},"/cypress/plugins/index.js")," file like so:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-js",metastring:'title="cypress/plugins/index.js"',title:'"cypress/plugins/index.js"'},'const { GoogleSocialLogin } = require("cypress-social-logins").plugins\n\nmodule.exports = (on, config) => {\n  on("task", {\n    GoogleSocialLogin: GoogleSocialLogin,\n  })\n}\n')),(0,a.kt)("p",null,"Finally, you can also add the following npm scripts to your ",(0,a.kt)("inlineCode",{parentName:"p"},"package.json"),":"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-json"},'"test:e2e:open": "cypress open",\n"test:e2e:run": "cypress run"\n')),(0,a.kt)("h2",{id:"writing-a-test"},"Writing a test"),(0,a.kt)("p",null,"Once we've got all that configuration out of the way, we can begin writing tests to login using NextAuth.js."),(0,a.kt)("p",null,"The basic login test looks like this:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-js",metastring:'title="cypress/integration/login.js"',title:'"cypress/integration/login.js"'},'describe("Login page", () => {\n  before(() => {\n    cy.log(`Visiting https://company.tld`)\n    cy.visit("/")\n  })\n  it("Login with Google", () => {\n    const username = Cypress.env("GOOGLE_USER")\n    const password = Cypress.env("GOOGLE_PW")\n    const loginUrl = Cypress.env("SITE_NAME")\n    const cookieName = Cypress.env("COOKIE_NAME")\n    const socialLoginOptions = {\n      username,\n      password,\n      loginUrl,\n      headless: true,\n      logs: false,\n      isPopup: true,\n      loginSelector: `a[href="${Cypress.env(\n        "SITE_NAME"\n      )}/api/auth/signin/google"]`,\n      postLoginSelector: ".unread-count",\n    }\n\n    return cy\n      .task("GoogleSocialLogin", socialLoginOptions)\n      .then(({ cookies }) => {\n        cy.clearCookies()\n\n        const cookie = cookies\n          .filter((cookie) => cookie.name === cookieName)\n          .pop()\n        if (cookie) {\n          cy.setCookie(cookie.name, cookie.value, {\n            domain: cookie.domain,\n            expiry: cookie.expires,\n            httpOnly: cookie.httpOnly,\n            path: cookie.path,\n            secure: cookie.secure,\n          })\n\n          Cypress.Cookies.defaults({\n            preserve: cookieName,\n          })\n\n          // remove the two lines below if you need to stay logged in\n          // for your remaining tests\n          cy.visit("/api/auth/signout")\n          cy.get("form").submit()\n        }\n      })\n  })\n})\n')),(0,a.kt)("p",null,"Things to note here include, that you must adjust the CSS selector defined under ",(0,a.kt)("inlineCode",{parentName:"p"},"postLoginSelector")," to match a selector found on your page after the user is logged in. This is how Cypress knows whether it succeeded or not. Also, if you're using another provider, you will have to adjust the ",(0,a.kt)("inlineCode",{parentName:"p"},"loginSelector")," URL."))}g.isMDXComponent=!0}}]);