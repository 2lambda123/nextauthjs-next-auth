"use strict";(self.webpackChunknext_auth_docs=self.webpackChunknext_auth_docs||[]).push([[3228],{3905:function(e,t,n){n.d(t,{Zo:function(){return d},kt:function(){return m}});var a=n(7294);function r(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function i(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function o(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?i(Object(n),!0).forEach((function(t){r(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):i(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function l(e,t){if(null==e)return{};var n,a,r=function(e,t){if(null==e)return{};var n,a,r={},i=Object.keys(e);for(a=0;a<i.length;a++)n=i[a],t.indexOf(n)>=0||(r[n]=e[n]);return r}(e,t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);for(a=0;a<i.length;a++)n=i[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(r[n]=e[n])}return r}var s=a.createContext({}),u=function(e){var t=a.useContext(s),n=t;return e&&(n="function"==typeof e?e(t):o(o({},t),e)),n},d=function(e){var t=u(e.components);return a.createElement(s.Provider,{value:t},e.children)},p={inlineCode:"code",wrapper:function(e){var t=e.children;return a.createElement(a.Fragment,{},t)}},c=a.forwardRef((function(e,t){var n=e.components,r=e.mdxType,i=e.originalType,s=e.parentName,d=l(e,["components","mdxType","originalType","parentName"]),c=u(n),m=r,h=c["".concat(s,".").concat(m)]||c[m]||p[m]||i;return n?a.createElement(h,o(o({ref:t},d),{},{components:n})):a.createElement(h,o({ref:t},d))}));function m(e,t){var n=arguments,r=t&&t.mdxType;if("string"==typeof e||r){var i=n.length,o=new Array(i);o[0]=c;var l={};for(var s in t)hasOwnProperty.call(t,s)&&(l[s]=t[s]);l.originalType=e,l.mdxType="string"==typeof e?e:r,o[1]=l;for(var u=2;u<i;u++)o[u]=n[u];return a.createElement.apply(null,o)}return a.createElement.apply(null,n)}c.displayName="MDXCreateElement"},3614:function(e,t,n){n.r(t),n.d(t,{frontMatter:function(){return l},contentTitle:function(){return s},metadata:function(){return u},toc:function(){return d},default:function(){return c}});var a=n(7462),r=n(3366),i=(n(7294),n(3905)),o=["components"],l={},s="Next.js",u={unversionedId:"configuration/nextjs",id:"configuration/nextjs",isDocsHomePage:!1,title:"Next.js",description:"Middleware",source:"@site/docs/configuration/nextjs.md",sourceDirName:"configuration",slug:"/configuration/nextjs",permalink:"/configuration/nextjs",editUrl:"https://github.com/nextauthjs/docs/edit/main/docs/configuration/nextjs.md",tags:[],version:"current",lastUpdatedBy:"Bal\xe1zs Orb\xe1n",lastUpdatedAt:1643982356,formattedLastUpdatedAt:"2/4/2022",frontMatter:{},sidebar:"docs",previous:{title:"Events",permalink:"/configuration/events"},next:{title:"Overview",permalink:"/providers/overview"}},d=[{value:"Middleware",id:"middleware",children:[{value:"Prerequisites",id:"prerequisites",children:[],level:3},{value:"<code>callbacks</code>",id:"callbacks",children:[{value:"Description",id:"description",children:[],level:4},{value:"Example (default value)",id:"example-default-value",children:[],level:4}],level:3},{value:"<code>pages</code>",id:"pages",children:[{value:"Description",id:"description-1",children:[],level:4},{value:"Example (default value)",id:"example-default-value-1",children:[],level:4}],level:3},{value:"Examples",id:"examples",children:[{value:"default re-export",id:"default-re-export",children:[],level:4},{value:"default <code>withAuth</code> export",id:"default-withauth-export",children:[],level:4},{value:"wrap middleware",id:"wrap-middleware",children:[],level:4}],level:3},{value:"Caveats",id:"caveats",children:[],level:3}],level:2}],p={toc:d};function c(e){var t=e.components,n=(0,r.Z)(e,o);return(0,i.kt)("wrapper",(0,a.Z)({},p,n,{components:t,mdxType:"MDXLayout"}),(0,i.kt)("h1",{id:"nextjs"},"Next.js"),(0,i.kt)("h2",{id:"middleware"},"Middleware"),(0,i.kt)("p",null,"You can use a Next.js Middleware with NextAuth.js to protect your site."),(0,i.kt)("p",null,"Next.js 12 has introduced ",(0,i.kt)("a",{parentName:"p",href:"https://nextjs.org/docs/middleware"},"Middleware"),". It is a way to run logic before accessing any page, even when they are static. On platforms like Vercel, Middleware is run at the ",(0,i.kt)("a",{parentName:"p",href:"https://nextjs.org/docs/api-reference/edge-runtime"},"Edge"),"."),(0,i.kt)("p",null,"If the following options look familiar, this is because they are a subset of ",(0,i.kt)("a",{parentName:"p",href:"/configuration/options#options"},"these options"),". You can extract these to a common configuration object to reuse them. In the future, we would like to be able to run everything in Middleware. (See ",(0,i.kt)("a",{parentName:"p",href:"#caveats"},"Caveats"),")."),(0,i.kt)("p",null,"You can get the ",(0,i.kt)("inlineCode",{parentName:"p"},"withAuth")," middleware function from ",(0,i.kt)("inlineCode",{parentName:"p"},"next-auth/middleware")," either as a default or a named import:"),(0,i.kt)("h3",{id:"prerequisites"},"Prerequisites"),(0,i.kt)("p",null,"You must set the ",(0,i.kt)("a",{parentName:"p",href:"/configuration/options#nextauth_secret"},(0,i.kt)("inlineCode",{parentName:"a"},"NEXTAUTH_SECRET"))," environment variable when using this middleware. If you are using the ",(0,i.kt)("a",{parentName:"p",href:"/configuration/options#secret"},(0,i.kt)("inlineCode",{parentName:"a"},"secret")," option")," this value must match."),(0,i.kt)("p",null,(0,i.kt)("strong",{parentName:"p"},"We strongly recommend")," replacing the ",(0,i.kt)("inlineCode",{parentName:"p"},"secret")," value completely with this ",(0,i.kt)("inlineCode",{parentName:"p"},"NEXTAUTH_SECRET")," environment variable. This environment variable will be picked up by both the ",(0,i.kt)("a",{parentName:"p",href:"/configuration/options#options"},"NextAuth config"),", as well as the middleware config."),(0,i.kt)("hr",null),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-js"},'import withAuth from "next-auth/middleware"\n// or\nimport { withAuth } from "next-auth/middleware"\n')),(0,i.kt)("hr",null),(0,i.kt)("h3",{id:"callbacks"},(0,i.kt)("inlineCode",{parentName:"h3"},"callbacks")),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("strong",{parentName:"li"},"Required:")," No")),(0,i.kt)("h4",{id:"description"},"Description"),(0,i.kt)("p",null,"Callbacks are asynchronous functions you can use to control what happens when an action is performed."),(0,i.kt)("h4",{id:"example-default-value"},"Example (default value)"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-js"}," callbacks: {\n   authorized({ req , token }) {\n     if(token) return true // If there is a token, the user is authenticated\n   }\n }\n")),(0,i.kt)("hr",null),(0,i.kt)("h3",{id:"pages"},(0,i.kt)("inlineCode",{parentName:"h3"},"pages")),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("strong",{parentName:"li"},"Required"),": ",(0,i.kt)("em",{parentName:"li"},"No"))),(0,i.kt)("h4",{id:"description-1"},"Description"),(0,i.kt)("p",null,"Specify URLs to be used if you want to create custom sign in, and error pages. Pages specified will override the corresponding built-in page."),(0,i.kt)("h4",{id:"example-default-value-1"},"Example (default value)"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-js"},"pages: {\n  signIn: '/auth/signin',\n  error: '/auth/error',\n}\n")),(0,i.kt)("p",null,"See the documentation for the ",(0,i.kt)("a",{parentName:"p",href:"/configuration/pages"},"pages option")," for more information."),(0,i.kt)("hr",null),(0,i.kt)("h3",{id:"examples"},"Examples"),(0,i.kt)("p",null,(0,i.kt)("inlineCode",{parentName:"p"},"withAuth")," is very flexible, there are multiple ways to use it."),(0,i.kt)("div",{className:"admonition admonition-note alert alert--secondary"},(0,i.kt)("div",{parentName:"div",className:"admonition-heading"},(0,i.kt)("h5",{parentName:"div"},(0,i.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,i.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"14",height:"16",viewBox:"0 0 14 16"},(0,i.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"}))),"note")),(0,i.kt)("div",{parentName:"div",className:"admonition-content"},(0,i.kt)("p",{parentName:"div"},"If you do not define the options, NextAuth.js will use the default values for the omitted options."))),(0,i.kt)("h4",{id:"default-re-export"},"default re-export"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-js",metastring:'title="pages/_middleware.js"',title:'"pages/_middleware.js"'},'export { default } from "next-auth/middleware"\n')),(0,i.kt)("p",null,"With this one line, when someone tries to load any of your pages, they will have to be logged-in first. Otherwise, they are redirected to the login page. It will assume that you are using the ",(0,i.kt)("inlineCode",{parentName:"p"},"NEXTAUTH_SECRET")," environment variable."),(0,i.kt)("h4",{id:"default-withauth-export"},"default ",(0,i.kt)("inlineCode",{parentName:"h4"},"withAuth")," export"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-js",metastring:'title="pages/admin/_middleware.js"',title:'"pages/admin/_middleware.js"'},'import { withAuth } from "next-auth/middleware"\n\nexport default withAuth({\n  callbacks: {\n    authorized: ({ token }) => token?.role === "admin"\n  }\n})\n')),(0,i.kt)("p",null,"With the above code, you just made sure that only user's with the ",(0,i.kt)("inlineCode",{parentName:"p"},"admin")," role can access any of the pages under thge ",(0,i.kt)("inlineCode",{parentName:"p"},"/admin")," route. (Including nested routes as well, like ",(0,i.kt)("inlineCode",{parentName:"p"},"/admin/settings")," etc.)."),(0,i.kt)("h4",{id:"wrap-middleware"},"wrap middleware"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-ts",metastring:'title="pages/admin/_middleware.ts"',title:'"pages/admin/_middleware.ts"'},'import type { NextRequest } from "next/server"\nimport type { JWT } from "next-auth"\n\nimport { withAuth } from "next-auth/middleware"\n\nexport default withAuth(function middleware(req: NextRequest & { nextauth: { token: JWT } }) {\n  console.log(req.nextauth.token)\n}, {\n  callbacks: {\n    authorized: ({ token }) => token?.role === "admin"\n  }\n})\n')),(0,i.kt)("p",null,"The ",(0,i.kt)("inlineCode",{parentName:"p"},"middleware")," function will only be invoked if the ",(0,i.kt)("inlineCode",{parentName:"p"},"authorized")," callback returns ",(0,i.kt)("inlineCode",{parentName:"p"},"true"),"."),(0,i.kt)("hr",null),(0,i.kt)("h3",{id:"caveats"},"Caveats"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"Currently only supports session verification, as parts of the sign-in code need to run in a Node.js environment. In the future, we would like to make sure that NextAuth.js can fully run at the ",(0,i.kt)("a",{parentName:"li",href:"https://nextjs.org/docs/api-reference/edge-runtime"},"Edge")),(0,i.kt)("li",{parentName:"ul"},"Only supports the ",(0,i.kt)("inlineCode",{parentName:"li"},'"jwt"')," ",(0,i.kt)("a",{parentName:"li",href:"/configuration/options#session"},"session strategy"),". We need to wait until databases at the Edge become mature enough to ensure a fast experience. (If you know of an Edge-compatible database, we would like if you proposed a new ",(0,i.kt)("a",{parentName:"li",href:"/tutorials/creating-a-database-adapter"},"Adapter"),")")))}c.isMDXComponent=!0}}]);